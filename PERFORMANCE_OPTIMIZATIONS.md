# 性能優化說明

## 已實施的優化

### 1. 減少日誌輸出（最大性能提升）
- 新增 `ENABLE_DEBUG_LOG` 開關（預設 `false`）
- 大部分除錯日誌被關閉，只保留關鍵資訊
- 減少字串拼接和 console 輸出的開銷
- **預期提升**: 50-70% 速度提升

### 2. 優化網格採樣精度
- 從 20×20 (400次檢測) 降到 10×10 (100次檢測)
- 精度損失：5% → 10%（仍可接受）
- **預期提升**: 75% 可見性計算速度提升

### 3. 新增性能監控
- 記錄每次查詢耗時
- 超過 100ms 時發出警告
- 方便追蹤性能問題

### 4. 視窗快取保持不變
- 500ms 快取週期已經是合理的平衡
- 避免過度快取導致視窗狀態不同步

## 性能基準測試

### 優化前（估計）
- 3個候選視窗：~150-250ms
- 6個候選視窗：~300-500ms
- 10個候選視窗：~500-800ms

### 優化後（預期）
- 3個候選視窗：~30-50ms ✅
- 6個候選視窗：~50-100ms ✅
- 10個候選視窗：~100-200ms ✅

## 進一步優化建議（若仍不夠快）

### 1. 簡化可見性計算
```typescript
// 選項A：跳過可見性檢查（不推薦，會降低準確性）
// 選項B：使用簡單的 Z-index 閾值（Z < 3 才視為可見）
// 選項C：只檢查是否完全被遮擋（不計算部分遮擋）
```

### 2. 預先過濾候選視窗
```typescript
// 根據方向提前過濾（在可見性計算前）
// up: 只檢查 Y < current.y 的視窗
// down: 只檢查 Y > current.y 的視窗
```

### 3. 使用 Web Worker（大改）
- 將視窗計算移到背景執行緒
- 不阻塞主執行緒
- 複雜度高，收益有限

## 開啟除錯模式

若需要詳細日誌進行除錯：

```typescript
// src/main/windowManager.ts 第 14 行
private readonly ENABLE_DEBUG_LOG = true; // 改為 true
```

重新編譯後即可看到完整日誌。
