# Visual Focusing è¦–çª—æœå°‹æ±ºç­–æµç¨‹åœ–

æœ¬æ–‡ä»¥**ã€Œå‘ä¸Šæœå°‹ã€**ç‚ºä»£è¡¨ï¼Œå®Œæ•´å‘ˆç¾å¾ä½¿ç”¨è€…æŒ‰ä¸‹å¿«æ·éµåˆ°æœ€çµ‚é¸å®šç›®æ¨™è¦–çª—çš„æ±ºç­–æµç¨‹ã€‚å…¶ä»–æ–¹å‘ï¼ˆä¸‹ã€å·¦ã€å³ï¼‰çš„é‚è¼¯çµæ§‹ç›¸åŒï¼Œåƒ…æ–¹å‘åˆ¤å®šæ¢ä»¶èˆ‡è·é›¢è¨ˆç®—è»¸å‘ä¸åŒã€‚

---

## å®Œæ•´æ±ºç­–æµç¨‹

```mermaid
flowchart TD
    Start(["ğŸ¯ ä½¿ç”¨è€…æŒ‰ä¸‹ã€Œå‘ä¸Šåˆ‡æ›ã€å¿«æ·éµ"])
    Start --> GetWindows

    %% ===== éšæ®µä¸€ï¼šå–å¾—èˆ‡å‰è™•ç† =====
    subgraph Phase1["éšæ®µä¸€ï¼šå–å¾—è¦–çª—åˆ—è¡¨"]
        GetWindows["å‘¼å« getAllWindows()<br>å–å¾—æ‰€æœ‰è¦–çª—åˆ—è¡¨"]
        GetWindows --> GetActive["å–å¾—ç•¶å‰ Active è¦–çª—"]
        GetActive --> HasActive{{"ç•¶å‰è¦–çª—<br>æ˜¯å¦å­˜åœ¨ï¼Ÿ"}}
        HasActive -- "å¦" --> ReturnNull1(["âŒ è¿”å› null<br>ç„¡æ³•åˆ‡æ›"])
        HasActive -- "æ˜¯" --> ExcludeCurrent["å¾åˆ—è¡¨ä¸­æ’é™¤ç•¶å‰è¦–çª—<br>ï¼ˆID + ä½ç½®é›™é‡æª¢æŸ¥ï¼‰"]
    end

    %% ===== éšæ®µäºŒï¼šå¯è¦‹æ€§éæ¿¾ =====
    subgraph Phase2["éšæ®µäºŒï¼šå¯è¦‹æ€§éæ¿¾"]
        ExcludeCurrent --> HasOthers{{"æ˜¯å¦æœ‰<br>å…¶ä»–è¦–çª—ï¼Ÿ"}}
        HasOthers -- "å¦" --> ReturnNull2(["âŒ è¿”å› null"])
        HasOthers -- "æ˜¯" --> VisCheck["é€ä¸€è¨ˆç®—æ¯å€‹è¦–çª—çš„<br>å¯¦éš›å¯è¦‹é¢ç©æ¯”ä¾‹"]
        VisCheck --> VisCalc
        
        subgraph VisCalc["calculateActualVisibleArea()"]
            direction TB
            V1["æ‰¾å‡ºæ‰€æœ‰ Z-index<br>æ¯”ç›®æ¨™å°ï¼ˆæ›´ä¸Šå±¤ï¼‰çš„è¦–çª—"]
            V1 --> V2{{"æœ‰ä¸Šå±¤è¦–çª—ï¼Ÿ"}}
            V2 -- "å¦" --> V3["å¯è¦‹æ¯”ä¾‹ = 1.0<br>ï¼ˆå®Œå…¨å¯è¦‹ï¼‰"]
            V2 -- "æ˜¯" --> V4{{"è¢«ä»»ä½•å–®ä¸€ä¸Šå±¤è¦–çª—<br>å®Œå…¨é®æ“‹ï¼Ÿ"}}
            V4 -- "æ˜¯" --> V5["å¯è¦‹æ¯”ä¾‹ = 0<br>ï¼ˆå®Œå…¨ä¸å¯è¦‹ï¼‰"]
            V4 -- "å¦" --> V6["è¨ˆç®—æ¯å€‹ä¸Šå±¤è¦–çª—<br>çš„é‡ç–Šæ¯”ä¾‹"]
            V6 --> V7["å¯è¦‹æ¯”ä¾‹ =<br>1 âˆ’ æœ€å¤§é‡ç–Šæ¯”ä¾‹"]
        end

        VisCalc --> FilterVis{{"å¯è¦‹æ¯”ä¾‹ > 0ï¼Ÿ"}}
        FilterVis -- "å¦" --> Exclude["æ’é™¤æ­¤è¦–çª—"]
        FilterVis -- "æ˜¯" --> KeepVis["ä¿ç•™ç‚ºå¯è¦‹è¦–çª—"]
        Exclude --> VisCheck
        KeepVis --> HasVisible
        HasVisible{{"æ˜¯å¦æœ‰<br>å¯è¦‹è¦–çª—ï¼Ÿ"}}
        HasVisible -- "å¦" --> ReturnNull3(["âŒ è¿”å› null"])
    end

    %% ===== éšæ®µä¸‰ï¼šæ–¹å‘æœå°‹ =====
    subgraph Phase3["éšæ®µä¸‰ï¼šæ–¹å‘åˆ¤å®šèˆ‡ç¯©é¸ï¼ˆä»¥å‘ä¸Šç‚ºä¾‹ï¼‰"]
        HasVisible -- "æ˜¯" --> DirFilter["ç¯©é¸ç¬¦åˆæ–¹å‘æ¢ä»¶çš„è¦–çª—"]
        
        DirFilter --> Cond1{{"æ¢ä»¶ 1ï¼š<br>target.y < current.y<br>ç›®æ¨™é ‚éƒ¨åœ¨ç•¶å‰é ‚éƒ¨ä¹‹ä¸Šï¼Ÿ"}}
        Cond1 -- "å¦" --> Skip1["æ’é™¤æ­¤è¦–çª—"]
        Cond1 -- "æ˜¯" --> Cond2{{"æ¢ä»¶ 2ï¼š<br>æœ‰æ°´å¹³é‡ç–Šï¼Ÿ<br>å³ X è»¸ç¯„åœæœ‰äº¤é›†"}}
        Cond2 -- "å¦" --> Skip1
        Cond2 -- "æ˜¯" --> PassFilter["âœ“ é€šéæ–¹å‘ç¯©é¸<br>åˆ—ç‚ºå€™é¸è¦–çª—"]
    end

    %% ===== éšæ®µå››ï¼šè©•åˆ†è¨ˆç®— =====
    subgraph Phase4["éšæ®µå››ï¼šè¨ˆç®—æ¯å€‹å€™é¸è¦–çª—çš„è©•åˆ†"]
        PassFilter --> CalcScore

        subgraph CalcScore["è©•åˆ†å…¬å¼"]
            direction TB
            S1["â‘  å¯è¦‹é¢ç©åˆ†æ•¸<br>visibleRatio Ã— 500<br>ï¼ˆæœ€é«˜ 500 åˆ†ï¼‰"]
            S2["â‘¡ è·é›¢æ‡²ç½°<br>Math.max(0, ç•¶å‰é ‚éƒ¨ âˆ’ ç›®æ¨™åº•éƒ¨)<br>ï¼ˆé‚Šåˆ°é‚Šè·é›¢ï¼Œæœ‰é‡ç–Šæ™‚ç‚º 0ï¼‰"]
            S3["â‘¢ Z-order æ‡²ç½°<br>zIndex Ã— 50<br>ï¼ˆè¶Šä¸‹å±¤æ‡²ç½°è¶Šå¤§ï¼‰"]
            S1 --> Formula["score = â‘  âˆ’ â‘¡ âˆ’ â‘¢"]
            S2 --> Formula
            S3 --> Formula
        end
    end

    %% ===== éšæ®µäº”ï¼šåˆ†çµ„èˆ‡å„ªå…ˆåº¦ =====
    subgraph Phase5["éšæ®µäº”ï¼šåˆ†çµ„æ’åº"]
        Formula --> Classify["åˆ¤æ–·æ¯å€‹å€™é¸è¦–çª—çš„é¡å‹"]

        Classify --> CheckOverlap{{"èˆ‡ç•¶å‰è¦–çª—<br>å®Œå…¨é‡ç–Šï¼Ÿ<br>ï¼ˆX ä¸” Y éƒ½æœ‰é‡ç–Šï¼‰"}}
        CheckOverlap -- "æ˜¯" --> CheckFS1{{"åŒ…å«ç•¶å‰è¦–çª—<br>ä¸”ä½”è¢å¹• â‰¥ 90%ï¼Ÿ"}}
        CheckFS1 -- "å¦" --> Group1["ğŸŸ¢ ç¬¬ä¸€çµ„ï¼šé‡ç–Šä¸€èˆ¬è¦–çª—<br>ï¼ˆæœ€é«˜å„ªå…ˆï¼‰"]
        CheckFS1 -- "æ˜¯" --> Group3["ğŸ”´ ç¬¬ä¸‰çµ„ï¼šå…¨è¢å¹•åŒ…å«è¦–çª—<br>ï¼ˆæœ€ä½å„ªå…ˆï¼‰"]
        CheckOverlap -- "å¦" --> CheckFS2{{"åŒ…å«ç•¶å‰è¦–çª—<br>ä¸”ä½”è¢å¹• â‰¥ 90%ï¼Ÿ"}}
        CheckFS2 -- "å¦" --> Group2["ğŸŸ¡ ç¬¬äºŒçµ„ï¼šä¸é‡ç–Šä¸€èˆ¬è¦–çª—<br>ï¼ˆä¸­ç­‰å„ªå…ˆï¼‰"]
        CheckFS2 -- "æ˜¯" --> Group3

        Group1 --> SelectGroup
        Group2 --> SelectGroup
        Group3 --> SelectGroup

        SelectGroup{{"ä¾å„ªå…ˆåº¦<br>é¸æ“‡éç©ºçš„çµ„åˆ¥"}}
        SelectGroup -- "ç¬¬ä¸€çµ„æœ‰è¦–çª—" --> Sort1["ç¬¬ä¸€çµ„æŒ‰ score é™åºæ’åˆ—"]
        SelectGroup -- "ç¬¬ä¸€çµ„ç©ºï¼Œç¬¬äºŒçµ„æœ‰" --> Sort2["ç¬¬äºŒçµ„æŒ‰ score é™åºæ’åˆ—"]
        SelectGroup -- "å‰å…©çµ„çš†ç©ºï¼Œç¬¬ä¸‰çµ„æœ‰" --> Sort3["ç¬¬ä¸‰çµ„æŒ‰ score é™åºæ’åˆ—"]
        SelectGroup -- "ä¸‰çµ„çš†ç©º" --> Fallback

        Sort1 --> Winner["ğŸ† é¸æ“‡ score æœ€é«˜çš„è¦–çª—"]
        Sort2 --> Winner
        Sort3 --> Winner
        Winner --> ReturnTarget(["âœ… è¿”å›ç›®æ¨™è¦–çª—"])
    end

    %% ===== éšæ®µå…­ï¼šå¾Œå‚™æœå°‹ =====
    subgraph Phase6["éšæ®µå…­ï¼šå¾Œå‚™æœå°‹"]
        Fallback["ä¸»æœå°‹ç„¡çµæœ<br>å•Ÿå‹•å¾Œå‚™æœå°‹"]

        Fallback --> FB_Filter["ç¯©é¸èˆ‡ç•¶å‰è¦–çª—å®Œå…¨é‡ç–Šçš„è¦–çª—<br>ï¼ˆX ä¸” Y éƒ½æœ‰äº¤é›†ï¼‰"]

        FB_Filter --> FB_Dir{{"Y > ç•¶å‰è¦–çª— Yï¼Ÿ<br>ï¼ˆåœ¨ä¸‹æ–¹ï¼‰"}}
        FB_Dir -- "å¦" --> FB_Skip["æ’é™¤"]
        FB_Dir -- "æ˜¯" --> FB_Type{{"æ˜¯å…¨è¢å¹•<br>åŒ…å«è¦–çª—ï¼Ÿ"}}
        FB_Type -- "å¦" --> FB_Normal["ä¸€èˆ¬è¦–çª—å€™é¸"]
        FB_Type -- "æ˜¯" --> FB_FS["å…¨è¢å¹•è¦–çª—å€™é¸"]

        FB_Normal --> FB_HasNormal{{"æœ‰ä¸€èˆ¬è¦–çª—<br>å€™é¸ï¼Ÿ"}}
        FB_HasNormal -- "æ˜¯" --> FB_SortNormal["æŒ‰ Y åº§æ¨™å‡åºæ’åˆ—<br>ï¼ˆé¸æœ€æ¥è¿‘çš„ï¼‰"]
        FB_SortNormal --> FB_Return(["âœ… è¿”å›æœ€è¿‘çš„è¦–çª—"])

        FB_HasNormal -- "å¦" --> FB_HasFS{{"æœ‰å…¨è¢å¹•è¦–çª—<br>å€™é¸ï¼Ÿ"}}
        FB_FS --> FB_HasFS
        FB_HasFS -- "æ˜¯" --> FB_SortFS["æŒ‰ Y åº§æ¨™å‡åºæ’åˆ—"]
        FB_SortFS --> FB_Return
        FB_HasFS -- "å¦" --> ReturnNull4(["âŒ è¿”å› null<br>ç„¡å¯åˆ‡æ›è¦–çª—"])
    end

    %% æ¨£å¼
    style Start fill:#4CAF50,color:#fff
    style ReturnTarget fill:#2196F3,color:#fff
    style FB_Return fill:#2196F3,color:#fff
    style ReturnNull1 fill:#f44336,color:#fff
    style ReturnNull2 fill:#f44336,color:#fff
    style ReturnNull3 fill:#f44336,color:#fff
    style ReturnNull4 fill:#f44336,color:#fff
    style Winner fill:#FF9800,color:#fff
    style Group1 fill:#4CAF50,color:#fff
    style Group2 fill:#FFC107,color:#333
    style Group3 fill:#f44336,color:#fff
    style Phase1 fill:#E3F2FD,stroke:#1565C0
    style Phase2 fill:#F3E5F5,stroke:#7B1FA2
    style Phase3 fill:#E8F5E9,stroke:#2E7D32
    style Phase4 fill:#FFF3E0,stroke:#E65100
    style Phase5 fill:#FCE4EC,stroke:#C62828
    style Phase6 fill:#EFEBE9,stroke:#4E342E
```

---

## å››å€‹æ–¹å‘çš„å·®ç•°å°ç…§

ä¸Šæ–¹æµç¨‹åœ–ä»¥ã€Œå‘ä¸Šæœå°‹ã€ç‚ºä¾‹ã€‚å››å€‹æ–¹å‘åƒ…ä»¥ä¸‹éƒ¨åˆ†ä¸åŒï¼š

| | å‘ä¸Š | å‘ä¸‹ | å‘å·¦ | å‘å³ |
|---|---|---|---|---|
| **æ–¹å‘æ¢ä»¶** | `target.y < current.y` | `targetBottom > currentBottom` | `target.x < current.x` | `targetRight > currentRight` |
| **é‡ç–Šè»¸æª¢æŸ¥** | æ°´å¹³é‡ç–Š | æ°´å¹³é‡ç–Š | å‚ç›´é‡ç–Š | å‚ç›´é‡ç–Š |
| **è·é›¢è¨ˆç®—** | `max(0, currentTop âˆ’ targetBottom)` | `max(0, targetTop âˆ’ currentBottom)` | `max(0, currentLeft âˆ’ targetRight)` | `max(0, targetLeft âˆ’ currentRight)` |
| **å¾Œå‚™æœå°‹æ–¹å‘** | å¾€ä¸‹æ‰¾ (`Y > current.y`) | å¾€ä¸Šæ‰¾ (`Y < currentBottom`) | å¾€å³æ‰¾ (`X > current.x`) | å¾€å·¦æ‰¾ (`X < currentRight`) |
| **å¾Œå‚™æ’åº** | Y å‡åºï¼ˆæœ€å° Yï¼‰ | Y é™åºï¼ˆæœ€å¤§ Yï¼‰ | X å‡åºï¼ˆæœ€å° Xï¼‰ | X é™åºï¼ˆæœ€å¤§ Xï¼‰ |

---

**æ–‡æª”ç‰ˆæœ¬**ï¼šv1.0
**æœ€å¾Œæ›´æ–°**ï¼š2026-02-27
